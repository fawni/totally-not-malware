use iced::widget::{self, button, column, container, image, row, text, text_input};
use iced::{
    alignment, event, keyboard, subscription, theme, window, Alignment, Application, Color,
    Command, Element, Event, Length, Settings, Subscription, Theme,
};

const TEXT_SIZE: u16 = 15;
const INPUT_LENGTH: u16 = 160;

pub fn main() -> iced::Result {
    Malware::run(Settings {
        window: window::Settings {
            size: (440, 180),
            resizable: false,
            icon: Some(
                window::Icon::from_file(format!(
                    "{}/resources/qhar.png",
                    env!("CARGO_MANIFEST_DIR")
                ))
                .unwrap(),
            ),
            ..window::Settings::default()
        },
        ..Settings::default()
    })
}

#[derive(Debug, Clone)]
enum Message {
    ThxPressed,
    CreditChanged(String),
    ExpirtyChanged(String),
    SecurityChanged(String),
    TabPressed { shift: bool },
    EnterPressed,
}

#[derive(Default)]
struct Malware {
    credit_value: String,
    expiry_value: String,
    security_value: String,
}

impl Malware {
    fn exit() {
        std::process::exit(0);
    }
}

impl Application for Malware {
    type Message = Message;
    type Executor = iced::executor::Default;
    type Theme = Theme;
    type Flags = ();

    fn new(_flags: ()) -> (Self, Command<Message>) {
        (Self::default(), widget::focus_next())
    }

    fn title(&self) -> String {
        String::from("Totally Not Malware")
    }

    fn update(&mut self, message: Message) -> Command<Message> {
        match message {
            Message::CreditChanged(value) => {
                let value = value
                    .chars()
                    .filter(|c| c.is_numeric())
                    .take(19)
                    .collect::<String>();
                self.credit_value = value;

                Command::none()
            }
            Message::ExpirtyChanged(value) => {
                let value = value
                    .chars()
                    .filter(|c| c.is_numeric())
                    .take(4)
                    .collect::<String>();
                self.expiry_value = value;

                Command::none()
            }
            Message::SecurityChanged(value) => {
                let value = value
                    .chars()
                    .filter(|c| c.is_numeric())
                    .take(3)
                    .collect::<String>();
                self.security_value = value;

                Command::none()
            }
            Message::TabPressed { shift } => {
                if shift {
                    widget::focus_previous()
                } else {
                    widget::focus_next()
                }
            }
            Message::ThxPressed | Message::EnterPressed => {
                Self::exit();
                unreachable!()
            }
        }
    }

    fn view(&self) -> Element<Message> {
        let handle = image::Handle::from_path(format!(
            "{}/resources/sofia.png",
            env!("CARGO_MANIFEST_DIR")
        ));

        let image = image(handle);

        let pls_text = text(
            "H-hi there...\nDo you th-think I could have your\ncredit card information, p-please?",
        )
        .size(TEXT_SIZE)
        .horizontal_alignment(alignment::Horizontal::Center);

        let credit_text = text("Card number: ").size(TEXT_SIZE);
        let credit_input = text_input("", &self.credit_value, Self::Message::CreditChanged)
            .size(TEXT_SIZE)
            .width(Length::Units(INPUT_LENGTH));

        let expiry_text = text("Expiry date:     ").size(TEXT_SIZE);
        let expiry_input = text_input("", &self.expiry_value, Self::Message::ExpirtyChanged)
            .size(TEXT_SIZE)
            .width(Length::Units(INPUT_LENGTH));

        let security_text = text("Security code: ").size(TEXT_SIZE);
        let security_input = text_input("", &self.security_value, Self::Message::SecurityChanged)
            .size(TEXT_SIZE)
            .width(Length::Units(INPUT_LENGTH));

        let thx_button = button("Th-thanks")
            .padding([0, 15])
            .on_press(Message::ThxPressed);

        let content = row![
            image,
            column![
                pls_text,
                row![credit_text, credit_input].align_items(Alignment::Center),
                row![expiry_text, expiry_input].align_items(Alignment::Center),
                row![security_text, security_input].align_items(Alignment::Center),
                thx_button,
            ]
            .align_items(Alignment::Center)
            .spacing(5)
            .padding(5)
        ]
        .align_items(Alignment::Center);

        container(content).into()
    }

    fn theme(&self) -> Theme {
        Theme::custom(theme::Palette {
            background: Color::WHITE,
            text: Color::BLACK,
            primary: Color::from_rgb8(179, 171, 183),
            ..theme::Palette::LIGHT
        })

        // Dark theme
        // Theme::custom(theme::Palette {
        //     background: Color::from_rgb8(70, 63, 76),
        //     text: Color::WHITE,
        //     primary: Color::from_rgb8(179, 171, 183),
        //     ..theme::Palette::DARK
        // })
    }

    fn subscription(&self) -> Subscription<Message> {
        subscription::events_with(|event, status| match (event, status) {
            (
                Event::Keyboard(keyboard::Event::KeyPressed {
                    key_code: keyboard::KeyCode::Tab,
                    modifiers,
                    ..
                }),
                event::Status::Ignored,
            ) => Some(Message::TabPressed {
                shift: modifiers.shift(),
            }),
            (
                Event::Keyboard(keyboard::Event::KeyPressed {
                    key_code: keyboard::KeyCode::Enter | keyboard::KeyCode::NumpadEnter,
                    ..
                }),
                event::Status::Ignored,
            ) => Some(Message::EnterPressed),
            _ => None,
        })
    }
}
